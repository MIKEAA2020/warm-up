clear all;
close all; clc
t = [1500:2500];

%  sol = dde23(@(t,N,Nlag)Bilogistic(t,N,Nlag,Ka,Kb,r,rm,K0),lags,@(t)Nhist(t,N0,Ka,r ),[1500,2500]);
% tint = linspace(1500,2500);
% yint = deval(sol,tint);
%     plot(tint,yint,'r');
%    grid on;
%  hold on;
  Xdata = [1950:2020];
%  Model_Predictions = deval(sol,Xdata);
% plot(Xdata,Model_Predictions,'k');
% hold on;
 %%%%%%%%%%%%%
%  rm = 0.0123;
%  sol = dde23(@(t,N,Nlag)Bilogistic(t,N,Nlag,Ka,Kb,r,rm,K0),lags,@(t)Nhist(t,N0,Ka,r ),[1500,2100]);
% tint = linspace(0,2100);
% yint = deval(sol,tint);
%    plot(tint,yint,'y');
%    grid on;
%  hold on;
 %%%%%%%%%%
%  t0 =1500;
 t0 = 1500;
%        Kt = Ka + (Kb-Ka)./(1+((Kb-Ka)/(K0-Ka)-1)*exp(-rm*(t-t0)));
%        plot (t,Kt,'b');
%        hold on;
%        K0 = 0.5001;
%        Kt = Ka + (Kb-Ka)./(1+((Kb-Ka)/(K0-Ka)-1)*exp(-rm*(t-t0)));
%        plot (t,Kt,'g');
%        hold on;
       %%%%%%%%%
       Xdata = [1950:2020];
Ydata = [2.53643100000000;2.58403400000000;2.63086200000000;2.67760900000000;2.72484700000000;2.77302000000000;2.82244300000000;2.87330600000000;2.92568700000000;2.97957600000000;3.03495000000000;3.09184400000000;3.15042100000000;3.21100100000000;3.27397800000000;3.33958400000000;3.40792300000000;3.47877000000000;3.55159900000000;3.62568100000000;3.70043700000000;3.77576000000000;3.85165100000000;3.92778100000000;4.00379400000000;4.07948000000000;4.15466700000000;4.22950600000000;4.30453400000000;4.38050600000000;4.45800300000000;4.53699700000000;4.61738700000000;4.69956900000000;4.78401200000000;4.87092200000000;4.96056800000000;5.05252200000000;5.14542600000000;5.23744100000000;5.32723100000000;5.41428900000000;5.49892000000000;5.58159800000000;5.66315000000000;5.74421300000000;5.82489200000000;5.90504600000000;5.98479400000000;6.06423900000000;6.14349400000000;6.22262700000000;6.30177300000000;6.38118500000000;6.46115900000000;6.54190700000000;6.62351800000000;6.70594700000000;6.78908900000000;6.87276700000000;6.95682400000000;7.04119400000000;7.12582800000000;7.21058200000000;7.29529100000000;7.37979700000000;7.46402200000000;7.54785900000000;7.63109100000000;7.71346800000000;7.79479900000000]';
plot (Xdata,Ydata,'mo');
hold on;
 options = optimset('MaxFunEvals',10000,'MaxIter',1000);
% z = fminsearch(@ObjFun,[100,0.02093,0.0281,3,0.000002500,0.000002500],options);
%   [z,fval] = fminsearch(@ObjFun,[  72.4259    0.0275    0.0295    5.9554    0.6402    0.4629],options)
%   z = fminunc(@ObjFun,[76,0.02510,0.1,3.2,0.00003800,0.000038004],options);
% 80.8678    0.0240    0.0325    3.1136    0.0001    0.0001
   %[z,fval] = fminsearch(@ObjFun,[ 68.603400365184768361359601840377, 0.027893320534381704778326138693956, 0.024190995016248287297067065537703, 4.508640985078830709653630037792, 0.000074957940941653675203174000962747, 0.00017764635634544842859861013550926],options)
%         [z,fval] = fminsearch(@ObjFun,[74.3320    0.0257    0.0248    4.5990    0.0017    0.0111],options)

% [z,fval] = fminsearch(@ObjFun,[60.507693034771875773003557696939, 0.054671048538727896604072498121241, 0.027174800350333774834332700720552, 3.11678478334242434755196882179, 0.0000716878076881851799412315173754, 0.00015711305422833662243098373778594],options);
% z = [76,0.02510,0.1,3,0.00003800,0.00003800];
% z = [81.0743,0.0241,0.1859,3.0314,0.0000,0.0001];
% 93.4105    0.0238    0.1023    2.3613    0.0000    0.0001
%   
% % z = [73.940600000000003433342499192804    0.0262     0.1143     3.5209    0.0000069999999999999998949950195947789   0.0001];
% z = [80.927197385497683512767252977937, 0.024101197075804301622747871647334, 0.029109042035128799119636511250064, 3.1019199825004131199079893121962, 0.000069329849051981017865695783308766, 0.00015770955592118188248566823528307];
% lags = z(1);
% r = z(2);
% rm = z(3);
% Kb = z(4);
% K0 = z(5);
% N0 = z(6);
% sol = dde23(@(t,N,Nlag)Bilogistic(t,N,Nlag,Ka,Kb,r,rm,K0),lags,@(t)Nhist(t,N0,Ka,r ),[1500,2500]);
% tint = linspace(1500,2500);
% yint = deval(sol,tint);
% plot(tint,yint,'c');
hold on;
grid on;
% rm =0.0281;
% rm = 0.036 ;
% K0 = 0.000006;
% 
%     [z,fval] = fmincon(@ObjFun,[ 49.7227    0.0270    0.0194    5.2639    0.7673    0.4863],[],[],[],[],[40,0.01,0.01,3.9,0.4450002,0.4450002],[89,0.03,0.03,5.6,0.8,0.8],@mycons);
%     [z,fval] = fmincon(@ObjFun,[ 78.60340037, 0.0278933205, 0.024190995, 4.08640985079, 0.44549579, 0.4451776463563],[],[],[],[],[65,0.02,0.02,3.9,0.445,0.445],[100,0.038,0.038,4.6,0.59,0.59],@mycons);
   %65,0.02,0.02,4.1,0.0000002,0.0000002  80,0.03,0.03,4.6,0.5,0.5
% [z,fval] = fmincon(@ObjFun,[75,0.02093,0.193,3,0.0002500,0.0002500],[],[],[],[],[74,0.01,0,2.9,0.0000002,0.0000002],[80,0.09,0.2,3.6,0.5,0.5]);
% [z,fval] = fmincon(@ObjFun,[80.6217    0.0243    0.0289    3.1378    0.0001    0.0002],[],[],[],[],[76,0.01,0.01,2.9,0.0000002,0.0000002],[83,0.03,0.029,3.6,0.5,0.5]);
% [z,fval] = fmincon(@ObjFun,[80.8678    0.0240    0.0325    3.1136    0.0001    0.0001],[],[],[],[],[76,0.01,0.01,2.9,0.0000002,0.0000002],[83,0.03,0.029,3.6,0.5,0.5])
 [z,fval] = fmincon(@ObjFun,[72.48301958, 0.029517485, 0.019677706, 5.532840487, 0.00031752, 0.000010024],[],[],[],[],[65,0.01,0.01,2.9,0.0000002,0.0000002],[83,0.03,0.029,5.6,0.5,0.5])


% z = [ 76.752557171660839685500832274556, 0.02927707218350169074416733394628, 0.018439078226586181480373127783423, 5.4979023897943930521137190226, 0.00048991466219582306337865240664087, 0.00001000089889062072462573311365519];
%  z = [ 80.946072002793130195641424506903, 0.027949640072523575240470705693951, 0.018621904104292236192819132156728, 4.3759942796379833751529986329842, 0.0005313805941779609813904738935264, 0.000016812507734207597469289208191867];
% % z = [ 72.483019580773387247063510585576, 0.02951748510526177801671643408099, 0.019677706231696904387584723394866, 5.5328404872484826526601864316035, 0.00031751680439304598782546129598359, 0.000010024301552500612156899190141601];
% z = [72.483019580773387247063510585576, 0.02951748510526177801671643408099, 0.019677706231696904387584723394866, 5.5328404872484826526601864316035, 0.00031751680439304598782546129598359, 0.000010024301552500612156899190141601];
z = [80.9250    0.0258    0.0232    3.3163    0.0017    0.0120];
 z =[ 72.483019580773387247063510585576, 0.02951748510526177801671643408099, 0.019677706231696904387584723394866, 5.5328404872484826526601864316035, 0.00031751680439304598782546129598359, 0.000010024301552500612156899190141601];

lags = z(1);
r = z(2);
rm = z(3);
Kb = z(4);
K0 = z(5);
N0 = z(6);
sol = dde23(@(t,N,Nlag)Bilogistic(t,N,Nlag,Ka,Kb,r,rm,K0),lags,@(t)Nhist(t,N0,Ka,r ),[1500,2500]);
tint = linspace(1500,2500);
yint = deval(sol,tint);
plot(tint,yint,'c','LineWidth',1.5);
xlabel('Year', 'FontSize', 14);
ylabel('Population in billions','FontSize', 14);
hold on;

Kt = Ka + (Kb-Ka)./(1+((Kb-Ka)/(K0-Ka)-1)*exp(-rm*(t-t0)));
       plot (t,Kt,'b','LineWidth',1.5);
       grid on;
       hold on;
%    legend('Population data', 'Model predictions', 'Historical carrying capacity (modeled)');
%% Searches for global minimum of error function
opts = optimoptions(@fmincon,'Algorithm','interior-point');
problem = createOptimProblem('fmincon','objective',...  %
@ObjFun,'x0',[72.48, 0.0295, 0.0196780, 5.5328, 0.00032, 0.0000100],'lb',[52,0.010,0.01,4.0,0.00001,0.00001],'ub',[83,0.03,0.03,5.9,0.0009,0.0009],'nonlcon',@mycons,'options',opts);%  
%     @ObjFun,'x0',[68.9702    0.0273    0.0247    5.7979    0.0001    0.0002],'lb',[52,0.010,0.01,4.0,0.00001,0.00001],'ub',[83,0.03,0.03,5.9,0.0009,0.0009],'nonlcon',@mycons,'options',opts);%  
%  @ObjFun,'x0',[77.1861    0.0283    0.0232    4.7676    0.5    0.4846],'lb',[39,0.010,0.01,2.0,0.445001,0.445001],'ub',[93,0.03,0.04,8,1,1],'nonlcon',@mycons,'options',opts);
%  @ObjFun,'x0',[72.3225    0.0256    0.0249    4.5814    0.0018    0.0112],'lb',[39,0.010,0.01,2.0,0.000500,0.000500],'ub',[93,0.03,0.04,8,1,1],'nonlcon',@mycons,'options',opts);

gs = GlobalSearch;
   [x,f] = run(gs,problem)

%% multistart: Searches for minimum of error function from multiple starting points
% opts = optimoptions(@fmincon,'Algorithm','sqp');
% problem = createOptimProblem('fmincon','objective',...
%   @ObjFun,'x0',[81.0743    0.0241    0.1859    3.0314    0.0000    0.0001],'lb',[80,0.02,0.1,3,0.0000,0.0001],'ub',[82,0.03,0.19,3.1,0.0002,0.0002],'options',opts);
% %   @ObjFun,'x0',[81.0743    0.0241    0.1859    3.0314    0.0000    0.0001],'lb',[40,0.01,0.01,2.9,0.00000,0.00009],'ub',[120,0.04,0.2,4,0.0002,0.0002],'options',opts);
% % [81.0743    0.0241    0.1859    3.0314    0.0000    0.0001];
% ms = MultiStart;
% [x,f] = run(ms,problem,20)
opts = optimoptions(@fmincon,'Algorithm','interior-point');
problem = createOptimProblem('fmincon','objective',...
 @ObjFun,'x0',[57.1861    0.0283    0.0232    4.7676    0.7298    0.4846],'lb',[30,0.01,0.01,4.1,0.44001,0.44001],'ub',[85,0.03,0.03,5.9,1,1],'nonlcon',@mycons,'options',opts);
 %@ObjFun,'x0',[80.8272, 0.0241, 0.02911, 3.102, 0.000069, 0.000168],'lb',[70,0.01,0.01,2.9,0.0000,0.0001],'ub',[85,0.03,0.03,3.5,0.0001,0.0002],'nonlcon',@mycons,'options',opts);
% 57.1861    0.0283    0.0232    4.7676    0.7298    0.4846
% 68.9702    0.0273    0.0247    5.2219    0.0001    0.0002

ms = MultiStart;
%  [x,f] = run(ms,problem,20   )
%z = [73.9406    0.0242    0.1143    3.5209    0.0000    0.0001]
%Previous guess 81.0743    0.0241    0.1859    3.0314    0.0000    0.0001
% [80.8272, 0.0241, 0.029109042035128799119636511250064, 3.102, 0.000069, 0.000168]
%%Ideal logistic curve

%%%%%%%%%%
%w = [68.6039    0.0279    0.0242    4.5086    0.0001    0.0002];
% % w = [ 68.603929623179723762405046727508, 0.027893287821381951285815148366964, 0.024191015672565076288780261393185, 4.5085582651840043766355847765226, 0.000074957713198718162401004705408525, 0.00017769118861338969420256284070803];
 w =[ 72.483019580773387247063510585576, 0.02951748510526177801671643408099, 0.019677706231696904387584723394866, 5.5328404872484826526601864316035, 0.00031751680439304598782546129598359, 0.000010024301552500612156899190141601];
% w = [78.6034,0.02493,0.0205,5.4,0.44549,0.44509];

   my_fit = fitnlm(Xdata,Ydata,@nonlin_func,w) % Finds the confidence intervals of model parameters
hold on;
%%%%
    N0 =       0.318;
       r1 =     0.01305;
       r2 =     0.02175;
       r3 =     0.01346;
       r4 =     0.01002;
       t0 =        1927;
       
f = 0.45./(1+(0.45/N0-1)*exp(-r1*(t-t0))) + 3.05./(1+(3.05/N0-1)*exp(-r2*(t-t0))) + 3.5./(1+(3.5/N0-1)*exp(-r3*(t-t0))) + 7./(1+(7/N0-1)*exp(-r4*(t-t0)));
% % plot(t,f,'r -.','LineWidth',1.5);
% legend('Population data','Model predictions','Historial carrying capacity','Ideal carrying capacity');
% set(legend, 'Box', 'off');
% straight_t = [1965 1970 1975 1980 1985 1990];
% straight_y = [1.941 2.0667 2.1924 2.3181 2.4438 2.5695];
% 
% [fitresult, gof] = createFits1(straight_t, straight_y)
%%%%%%%%%%%%%%
USA_Earths = [
2.583361337
2.669822295
2.800862575
2.86569434
3.059937915
3.188351222
3.319762695
3.553625846
3.709300615
3.829891798
3.988875887
4.176174521
4.288919094
4.158616659
4.033200194
4.311940551
4.530938772
4.492610995
4.625356272
4.247468137
4.235545192
4.065089054
3.977438755
4.342423695
4.506133932
4.518144426
4.605784758
4.646789685
4.773940182
4.772617345
4.687616991
4.85938476
4.881385174
5.161680875
4.997215593
5.181442294
5.433659736
5.505725987
5.44145314
5.515267176
5.449814792
5.393947468
5.533767364
5.718044214
5.83855437
5.774772824
5.717309259
5.389760833
5.007951598
5.255591207
5.026571598
4.892393651
5.006492549
4.997116357
4.96621919
4.972742153
];

World_Earths = [
0.7323042549
0.7519263999
0.7814104254
0.8099916732
0.8377517412
0.8651423334
0.8847588556
0.9162532597
0.9544040073
1.005753034
1.031803488
1.063774198
1.108174108
1.103028958
1.094861866
1.140346274
1.162078705
1.17665108
1.209977989
1.188086669
1.161972552
1.146369625
1.149690264
1.177480134
1.188812464
1.206426308
1.235772103
1.270538095
1.285338283
1.286848177
1.291998919
1.280691653
1.282794322
1.291435122
1.31959709
1.330368409
1.345912901
1.343355841
1.344575373
1.375524854
1.382339309
1.398012015
1.451741573
1.498215483
1.54464076
1.581533548
1.619767123
1.614960783
1.592821003
1.670560899
1.693968931
1.693549717
1.703233415
1.695163158
1.687821786
1.685310414
];

World_Pop = [3.09184400000000;3.15042100000000;3.21100100000000;3.27397800000000;3.33958400000000;3.40792300000000;3.47877000000000;3.55159900000000;3.62568100000000;3.70043700000000;3.77576000000000;3.85165100000000;3.92778100000000;4.00379400000000;4.07948000000000;4.15466700000000;4.22950600000000;4.30453400000000;4.38050600000000;4.45800300000000;4.53699700000000;4.61738700000000;4.69956900000000;4.78401200000000;4.87092200000000;4.96056800000000;5.05252200000000;5.14542600000000;5.23744100000000;5.32723100000000;5.41428900000000;5.49892000000000;5.58159800000000;5.66315000000000;5.74421300000000;5.82489200000000;5.90504600000000;5.98479400000000;6.06423900000000;6.14349400000000;6.22262700000000;6.30177300000000;6.38118500000000;6.46115900000000;6.54190700000000;6.62351800000000;6.70594700000000;6.78908900000000;6.87276700000000;6.95682400000000;7.04119400000000;7.12582800000000;7.21058200000000;7.29529100000000;7.37979700000000;7.46402200000000];


t = [1961:2016];
A = [0.8,0.20];
Optimal_Earths = A(1).*World_Earths + A(2).*USA_Earths;
ratio = World_Pop./Optimal_Earths % ALTERNATIVE UPPER BOUND FOR CARRYING CAPACITY
plot(t,ratio,'g','Linewidth',1.5);
   legend('Population data', 'Model predictions', 'Historical capacity (modeled)','Historical capacity( 80/20 rule)');